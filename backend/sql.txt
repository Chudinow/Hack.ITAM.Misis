-- Основная таблица хакатонов
CREATE TABLE hackathons (
    id SERIAL PRIMARY KEY,
    -- Основная информация
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL, -- ai-hackathon-2024
    description TEXT,
    detailed_description TEXT,
    
    -- Даты
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    registration_start TIMESTAMP,
    registration_end TIMESTAMP,
    
    -- Место проведения
    location_type VARCHAR(20) DEFAULT 'offline', -- online/offline/hybrid
    location_address TEXT,
    location_coordinates POINT, -- для карты
    online_link VARCHAR(500),
    
    -- Организатор
    organizer_id INTEGER NOT NULL REFERENCES organizers(id),
    created_by INTEGER NOT NULL REFERENCES users(id),
    
    -- Статус и видимость
    status VARCHAR(20) DEFAULT 'draft', -- draft/published/archived/cancelled
    is_featured BOOLEAN DEFAULT FALSE,
    visibility VARCHAR(20) DEFAULT 'public', -- public/private/unlisted
    
    -- Ограничения
    max_participants INTEGER,
    max_teams INTEGER DEFAULT 100,
    min_team_size INTEGER DEFAULT 1,
    max_team_size INTEGER DEFAULT 5,
    
    -- Призы и финансы
    prize_fund DECIMAL(10, 2),
    currency VARCHAR(3) DEFAULT 'RUB',
    registration_fee DECIMAL(10, 2) DEFAULT 0,
    
    -- Метаданные
    cover_image_url VARCHAR(500),
    logo_url VARCHAR(500),
    website_url VARCHAR(500),
    
    -- Системные поля
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP,
    
    -- Индексы
    INDEX idx_hackathons_organizer (organizer_id),
    INDEX idx_hackathons_status (status),
    INDEX idx_hackathons_dates (start_date, end_date),
    
    -- Ограничения
    CHECK (end_date > start_date),
    CHECK (registration_end IS NULL OR registration_end >= registration_start)
);

-- Таблица тегов хакатона
CREATE TABLE hackathon_tags (
    hackathon_id INTEGER REFERENCES hackathons(id) ON DELETE CASCADE,
    tag VARCHAR(50) NOT NULL,
    PRIMARY KEY (hackathon_id, tag)
);

-- Таблица партнеров/спонсоров
CREATE TABLE hackathon_partners (
    id SERIAL PRIMARY KEY,
    hackathon_id INTEGER REFERENCES hackathons(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    logo_url VARCHAR(500),
    website_url VARCHAR(500),
    partner_type VARCHAR(50), -- sponsor/partner/organizer
    tier VARCHAR(50), -- platinum/gold/silver
    order_index INTEGER DEFAULT 0
);

-- Таблица настроек хакатона
CREATE TABLE hackathon_settings (
    hackathon_id INTEGER PRIMARY KEY REFERENCES hackathons(id) ON DELETE CASCADE,
    -- Регистрация
    allow_registration BOOLEAN DEFAULT TRUE,
    require_approval BOOLEAN DEFAULT FALSE,
    registration_form_schema JSONB, -- кастомные поля формы
    
    -- Команды
    allow_team_creation BOOLEAN DEFAULT TRUE,
    allow_solo_participation BOOLEAN DEFAULT TRUE,
    team_matching_enabled BOOLEAN DEFAULT FALSE,
    
    -- Контент
    custom_css TEXT,
    custom_js TEXT,
    theme_color VARCHAR(7) DEFAULT '#667eea',
    
    -- Интеграции
    telegram_group_link VARCHAR(500),
    discord_invite_link VARCHAR(500),
    notion_page_url VARCHAR(500),
    
    -- Модерация
    auto_approve_teams BOOLEAN DEFAULT FALSE,
    require_project_submission BOOLEAN DEFAULT TRUE,
    submission_deadline TIMESTAMP
);
